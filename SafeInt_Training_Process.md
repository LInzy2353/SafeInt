# SafeInt 模型全训练过程

本文档详细说明了 SafeInt 模型的完整训练流程，包括数据准备、表征提取、分类器训练、SafeInt 模型训练以及评估等步骤。

## 1. 训练流程概述

SafeInt 模型的训练流程包括以下五个主要步骤：

1. **表征提取**：从预训练 LLM 中提取中间层表征
2. **分类器训练**：训练逻辑回归分类器，用于风险检测
3. **SafeInt 模型训练**：训练表征重定位模块
4. **推理测试**：使用训练好的模型进行推理
5. **全面评估**：评估模型的防御效果、效用保持和鲁棒性

## 2. 环境准备

### 2.1 依赖安装

```bash
pip install -r requirements.txt
```

### 2.2 数据准备

训练数据包括三类：
- 安全数据（safe）：普通无害查询
- 越狱数据（jailbreak）：包含越狱提示的查询
- 不安全数据（unsafe）：包含有害内容的查询

数据存放在 `data/train/` 目录下：
- `train_safe.json`：安全数据
- `train_jailbreak.json`：越狱数据
- `train_unsafe.json`：不安全数据

## 3. 训练命令

使用以下命令启动完整训练流程：

```bash
nohup python src/main.py \
  --model_path /home/blcu_lzy2025/.cache/huggingface/hub/models--lmsys--vicuna-7b-v1.5/snapshots/3321f76e3f527bd14065daf69dad9344000a201d \
  --mode full \
  --epochs 30 \
  --batch_size 16 \
  --learning_rate 5e-5 \
  --intervention_layer 12 \
  --alignment_layers 13-24 \
  --subspace_rank 64 \
  --alpha 1.5 \
  --beta 0.2 \
  --temperature 0.1 \
  --layers 10-25 > output.log 2>&1 &
```

### 3.1 参数说明

- `--model_path`：预训练模型路径
- `--mode`：运行模式，`full` 表示完整流程
- `--epochs`：训练轮次
- `--batch_size`：批次大小
- `--learning_rate`：学习率
- `--intervention_layer`：干预层，论文推荐第 12 层
- `--alignment_layers`：对齐层范围，如 "13-24"
- `--subspace_rank`：低秩子空间维度 r，这里设置为 64
- `--alpha`：对齐损失权重，设置为 1.5 增强干预强度
- `--beta`：重建损失权重，设置为 0.2
- `--temperature`：对比损失温度参数，设置为 0.1
- `--layers`：处理的层范围，如 "10-25"

## 4. 训练流程详解

### 4.1 表征提取

在这一步骤中，系统会从预训练的 LLM 中提取中间层表征：

1. 加载训练数据（安全、越狱和不安全数据）
2. 对每条数据进行编码并通过模型前向传播
3. 提取指定层（10-25 层）的中间表征
4. 将提取的表征保存到 `embeddings` 目录

### 4.2 分类器训练

基于提取的表征训练逻辑回归分类器：

1. 加载提取的表征数据
2. 对每一层训练单独的逻辑回归分类器
3. 评估分类器性能，选择最佳层（通常是第 12 层）
4. 保存训练好的分类器模型

### 4.3 SafeInt 模型训练

训练 SafeInt 的表征重定位模块：

1. 初始化表征重定位器、对齐器和重建器
2. 加载提取的表征数据
3. 训练过程包括：
   - 计算对齐损失：确保干预后的表征与安全表征对齐
   - 计算重建损失：确保干预不会过度改变原始语义
   - 优化表征重定位模块参数
4. 保存训练好的模型参数

### 4.4 推理测试

使用训练好的模型进行推理测试：

1. 加载训练好的 SafeInt 模型
2. 对测试输入进行处理
3. 生成响应并进行风险评估
4. 根据风险评分决定是否拒绝响应

### 4.5 全面评估

对模型进行全面评估：

1. **防御效果评估**：
   - 使用越狱和不安全数据测试模型
   - 计算攻击成功率（ASR）
   - 分析不同类型攻击的防御效果

2. **效用保持评估**：
   - 比较使用和不使用 SafeInt 的响应质量
   - 确保效用损失不超过 2%

3. **鲁棒性评估**：
   - 使用自适应攻击测试模型
   - 评估模型对未见过攻击的防御能力

## 5. 训练结果

训练完成后，可以在以下位置找到相关结果：

- 训练日志：`output.log`
- 模型参数：`models/safeint/`
- 评估报告：`results/evaluation/comprehensive_evaluation_report.md`
- 可视化结果：`results/evaluation/` 目录下的各种图表

## 6. 关键技术亮点

### 6.1 表征重定位

SafeInt 的核心是表征重定位技术，通过公式：

```
h̃^(I) = h^(I) + alpha * U^T·(f_θ(h^(I)) - U·h^(I))
```

其中：
- h^(I) 是原始表征
- h̃^(I) 是干预后的表征
- U 是低秩投影矩阵
- f_θ 是线性重定位模块
- alpha = 1.5 是干预强度系数（增强版）

### 6.2 风险检测机制

系统通过训练的逻辑回归分类器动态检测输入的风险级别，并结合关键词匹配和模式识别，实现对越狱和不安全内容的有效识别。

### 6.3 表征对齐与重建

训练过程中通过对齐损失和重建损失的平衡，确保干预既能有效防御攻击，又能保持模型的基本效用。

## 7. 结论

SafeInt 模型通过表征重定位技术，在不需要微调或重训练 LLM 的情况下，实现了对越狱攻击的有效防御，同时保持了模型的基本效用。实验结果表明，增强版 SafeInt（alpha=1.5）能够将攻击成功率（ASR）降至接近 0，同时效用损失控制在 2% 以内。